# 출결 관리 자동 캡처 시스템

온라인 강의(Zoom) 출결 증빙을 위한 자동 화면 캡처 프로그램입니다.

InsightFace 딥러닝 모델을 사용하여 얼굴을 감지하고, 설정한 인원 기준을 충족할 때 자동으로 화면을 캡처합니다.

---

## 📋 목차

- [주요 기능](#-주요-기능)
- [시스템 요구사항](#-시스템-요구사항)
- [설치 방법](#-설치-방법)
  - [방법 1: EXE 파일 실행 (권장)](#방법-1-exe-파일-실행-권장)
  - [방법 2: Python 소스 실행 (개발자용)](#방법-2-python-소스-실행-개발자용)
- [사용 방법](#-사용-방법)
  - [초기 설정](#1-초기-설정)
  - [메인 화면](#2-메인-화면)
  - [캡처 모드](#3-캡처-모드)
  - [교시별 제어](#4-교시별-제어)
- [파일 저장 구조](#-파일-저장-구조)
- [트러블슈팅](#-트러블슈팅)
- [개발자 정보](#-개발자-정보)

---

## ✨ 주요 기능

### 핵심 기능
- **자동 얼굴 감지**: InsightFace 딥러닝 모델 (정확도 95~99%)
- **GPU 가속**: NVIDIA GTX 960 지원 (CPU 자동 fallback)
- **자동 스케줄링**: 교시별 시간대(30~45분) 자동 캡처
- **듀얼 모니터 지원**: 캡처할 모니터 선택 가능
- **유연한 인원 감지**: 조명/각도 문제 고려한 유연 모드 (90% 기준)

### 편의 기능
- **건너뛰기**: 특정 교시 캡처 생략
- **재시도**: 캡처 실패 시 수동 재시도
- **실시간 인원 조정**: 지각/조퇴 발생 시 즉시 반영
- **CSV 로그**: 모든 캡처 이벤트 자동 기록
- **설정 저장**: 프로그램 종료 시 설정 자동 저장

---

## 💻 시스템 요구사항

### EXE 실행 시 (권장)
- **OS**: Windows 10 이상
- **RAM**: 4GB 이상
- **디스크**: 2GB 이상 여유 공간
- **GPU** (선택사항):
  - NVIDIA GTX 960 이상 (권장)
  - NVIDIA 드라이버만 설치 (CUDA Toolkit 불필요 - EXE에 포함)
  - GPU 없을 시 CPU 모드 자동 전환

### Python 소스 실행 시 (개발자용)
- **Python**: 3.10.11 (필수)
- **GPU** (선택사항):
  - NVIDIA 드라이버
  - CUDA Toolkit 11.x
- **패키지**: requirements.txt 참조

---

## 📦 설치 방법

### 방법 1: EXE 파일 실행 (권장)

**일반 사용자를 위한 간편 설치 방법입니다.**

1. **프로그램 다운로드**
   ```
   dist/출결관리/ 폴더 전체를 원하는 위치에 복사
   ```

2. **실행**
   ```
   출결관리.exe 더블클릭
   ```

3. **GPU 사용 시 (선택사항)**
   - NVIDIA GPU 사용 시: [NVIDIA 드라이버 다운로드](https://www.nvidia.com/download/index.aspx)
   - GPU 없을 시: 자동으로 CPU 모드로 동작 (별도 설치 불필요)

**주의사항:**
- Python 설치 불필요
- CUDA Toolkit 설치 불필요 (CUDA 런타임이 EXE에 포함됨)
- InsightFace 모델 자동 포함 (GitHub 다운로드 불필요)

**GPU 관련 용어 설명:**
- **NVIDIA 드라이버**: GPU 하드웨어를 운영체제가 인식하고 사용하기 위한 기본 소프트웨어
- **CUDA Toolkit**: GPU 병렬 연산(딥러닝)을 위한 개발 도구
  - EXE 사용 시: CUDA 런타임이 `onnxruntime-gpu`에 포함되어 번들링됨 → 드라이버만 설치하면 GPU 사용 가능
  - Python 소스 사용 시: CUDA Toolkit 별도 설치 필요

---

### 방법 2: Python 소스 실행 (개발자용)

**소스 코드를 수정하거나 개발하려는 경우**

#### 1. Python 설치
```bash
# Python 3.10.11 설치 (필수)
# https://www.python.org/downloads/release/python-31011/
```

#### 2. GPU 환경 설정 (선택사항)

**GPU 사용 시:**
```bash
# NVIDIA 드라이버 설치
# https://www.nvidia.com/download/index.aspx

# CUDA Toolkit 11.x 설치
# https://developer.nvidia.com/cuda-11-8-0-download-archive
```

#### 3. 가상환경 생성

**conda 사용 시 (권장):**
```bash
conda create -n capture python=3.10.11
conda activate capture
```

**venv 사용 시:**
```bash
python -m venv venv
venv\Scripts\activate  # Windows
```

#### 4. 패키지 설치
```bash
pip install -r requirements.txt
```

#### 5. 프로그램 실행
```bash
python main.py
```

**첫 실행 시:**
- InsightFace 모델 자동 다운로드 (~100MB)
- 다운로드 위치: `~/.insightface/models/buffalo_l/`

---

## 🚀 사용 방법

### 1. 초기 설정

프로그램 첫 실행 시 초기 설정 창이 표시됩니다.

**설정 항목:**
- **캡처 모니터**: 듀얼 모니터 환경에서 캡처할 모니터 선택
- **저장 경로**: 캡처 이미지 저장 위치 (기본: 바탕화면)
- **캡처 모드**: 정확 모드 또는 유연 모드 선택
- **출석 학생 수**: 강사 제외 학생 수 입력 (기본: 1명)

**확인 버튼 클릭 시:**
- 기준 인원 자동 계산 (학생 수 + 1명)
- 메인 화면 시작

---

### 2. 메인 화면

**상단 정보 영역:**
- 📅 현재 날짜 및 시간 (1초 업데이트)
- 📚 다음 교시까지 남은 시간
- 🖥️ 캡처 모니터 선택 (드롭다운으로 변경 가능)

**인원 관리 영역:**
- **캡처 모드**: 정확/유연 모드 전환
- **출석 학생 수**: 실시간 증감 (▲▼ 버튼 또는 직접 입력)
- **기준 인원**: 자동 계산 및 표시

**교시별 상태 영역:**
- 1~8교시 + 퇴실 (18:30~18:32)
- 각 교시별 상태: 🕒 대기중 | 🔍 감지중 | ✅ 완료 | ⏭️ 건너뛰기 | ⏰ 시간 초과
- [건너뛰기] [재시도] 버튼

**하단 버튼 영역:**
- 📁 저장 경로 설정: 저장 위치 변경
- 📂 저장 폴더 열기: 저장 경로 폴더 열기 (날짜별 하위 폴더 포함)

---

### 3. 캡처 모드

#### 정확 모드
- 감지 인원 == 기준 인원
- 예: 22명 감지 → 22명 기준 ✅ | 21명 감지 → 22명 기준 ❌

**사용 사례:**
- 모든 학생의 캠 환경이 완벽한 경우
- 엄격한 출결 관리가 필요한 특수 상황

#### 유연 모드
- 감지 인원 >= 기준 인원 × 0.9
- 예: 20명 감지 → 19.8명 (22 × 0.9) 이상 ✅

**사용 사례:**
- 일부 학생의 캠 환경이 불량한 경우
  - 어두운 방 (조명 불량)
  - 캠 각도 문제 (45도 이상 틀어짐)
  - 낮은 웹캠 화질
- 현실적인 출결 관리 (기본 권장)

---

### 4. 교시별 제어

#### 자동 캡처
- **시간대**: 각 교시 시작 시간 30분~45분 (15분간)
  - 1교시 (09:30 시작) → 09:30~09:45 캡처
  - 2교시 (10:30 시작) → 10:30~10:45 캡처
  - ... (8교시까지 동일)
- **퇴실**: 18:30~18:32 (2분간)
- **재시도 간격**: 10초

**캡처 성공 시:**
- 파일 저장
- 성공 알림창 표시
- 해당 교시 감지 중단

**캡처 실패 시:**
- 실패 알림창 표시
- 10초 후 자동 재시도
- 시간대 종료 시 중단

#### 건너뛰기
- 특정 교시 캡처 생략
- 예: 공휴일, 휴강 등

**사용법:**
1. 해당 교시 [건너뛰기] 버튼 클릭
2. 상태 변경: 🔍 감지중 → ⏭️ 건너뛰기
3. 자동 감지 중단

#### 재시도
- 캡처 실패 또는 사진 불만족 시 수동 재시도

**사용법:**
1. 해당 교시 [재시도] 버튼 클릭
2. 즉시 캡처 시도 시작

**파일 저장 규칙:**
- **시간대 내 재시도**: 기존 파일 덮어쓰기
  - `251128_1교시.png` → `251128_1교시.png` (덮어쓰기)
- **시간대 종료 후 재시도**: 새 파일 생성
  - `251128_1교시.png` (존재) → `251128_1교시_수정.png` (신규)

---

## 📁 파일 저장 구조

### 저장 위치
```
C:\IBM 비대면/
├─ 251128/                    # 날짜별 폴더 (YYMMDD)
│  ├─ 251128_1교시.png
│  ├─ 251128_2교시.png
│  ├─ 251128_3교시.png
│  ├─ 251128_3교시_수정.png   # 시간대 종료 후 재시도
│  ├─ 251128_4교시.png
│  ├─ 251128_5교시.png
│  ├─ 251128_6교시.png
│  ├─ 251128_7교시.png
│  ├─ 251128_8교시.png
│  ├─ 251128_퇴실.png
│  └─ 251128_log.csv          # 캡처 이벤트 로그
├─ 251129/
└─ 251130/
```

### 파일명 규칙
- **교시**: `YYMMDD_N교시.png` (예: `251128_1교시.png`)
- **수정**: `YYMMDD_N교시_수정.png` (예: `251128_1교시_수정.png`)
- **퇴실**: `YYMMDD_퇴실.png` (예: `251128_퇴실.png`)
- **로그**: `YYMMDD_log.csv` (예: `251128_log.csv`)

### CSV 로그 구조
```csv
날짜,시간,항목,상태,감지인원,기준인원,파일명,비고
2025-11-28,09:30:00,1교시,캡처 시작,0,22,,
2025-11-28,09:30:05,1교시,얼굴 감지,20,22,,
2025-11-28,09:30:07,1교시,캡처 성공,20,22,251128_1교시.png,유연 모드
```

---

## 🔧 트러블슈팅

### 1. 얼굴 감지 실패

**증상:**
- 실제 출석했는데 캡처 안 됨
- 계속 "얼굴 감지 실패" 알림

**원인:**
1. 실제 결석/지각
2. 학생 캠 환경 문제 (조명, 각도, 화질)
3. Zoom 화면 문제
4. 잘못된 모니터 선택
5. 기준 인원 설정 오류

**해결 방법:**
```
1. 학생 수 확인
   - 실제 출석 인원과 설정 인원 비교
   - 지각생 도착 시 ▲ 버튼으로 증가
   - 조퇴 시 ▼ 버튼으로 감소

2. 캡처 모드 확인
   - 유연 모드: 기준 인원의 90% 이상 (실제 환경 고려)
   - 정확 모드: 기준 인원 정확히 일치 (엄격한 관리)

3. 모니터 선택 확인
   - 상단 모니터 드롭다운에서 Zoom 화면 있는 모니터 선택

4. Zoom 화면 확인
   - 갤러리 뷰 활성화
   - 비디오 꺼진 참가자 숨기기
   - 화면 최대화

5. 수동 재시도
   - [재시도] 버튼 클릭
```

---

### 2. GPU 인식 실패

**증상:**
- "GPU 사용 불가" 경고 알림
- CPU 모드로 전환됨 (느림)

**원인:**
- NVIDIA 드라이버 미설치
- GPU 드라이버 오래됨
- CUDA 호환 문제

**해결 방법 (EXE 사용 시):**
```
1. NVIDIA 드라이버 업데이트
   - https://www.nvidia.com/download/index.aspx
   - GTX 960 검색 후 최신 드라이버 다운로드
   - 설치 후 재부팅

2. CUDA 별도 설치 불필요
   - EXE에 ONNX Runtime 포함됨
   - 드라이버만 설치하면 GPU 인식됨

3. CPU 모드 계속 사용
   - GPU 없어도 정상 동작 (속도만 조금 느림)
   - 얼굴 감지: 0.5초 (GPU) → 1~2초 (CPU)
```

**해결 방법 (Python 소스 사용 시):**
```
1. CUDA Toolkit 설치
   - https://developer.nvidia.com/cuda-11-8-0-download-archive
   - CUDA 11.8 권장

2. onnxruntime-gpu 재설치
   pip uninstall onnxruntime onnxruntime-gpu
   pip install onnxruntime-gpu==1.16.3
```

---

### 3. 파일 저장 실패

**증상:**
- "파일 저장 실패" 에러 알림
- 캡처는 성공했는데 파일 없음

**원인:**
- 저장 경로 권한 없음
- 디스크 공간 부족
- 폴더 접근 불가

**해결 방법:**
```
1. 저장 경로 변경
   - 하단 [📁 저장 경로 설정] 버튼 클릭
   - 권한 있는 폴더 선택 (예: 바탕화면)

2. 디스크 공간 확인
   - C 드라이브 여유 공간 확인
   - 불필요한 파일 삭제

3. 관리자 권한 실행
   - 프로그램 우클릭 → "관리자 권한으로 실행"
```

---

### 4. 프로그램 느림

**증상:**
- 화면 캡처 느림
- 얼굴 감지 오래 걸림
- 프로그램 응답 없음

**원인:**
- GPU 미사용 (CPU 모드)
- 메모리 부족
- 다른 프로그램 과부하

**해결 방법:**
```
1. GPU 사용 확인
   - 트러블슈팅 2번 참조 (GPU 인식 실패)

2. 메모리 확인
   - 작업 관리자에서 메모리 사용률 확인
   - 불필요한 프로그램 종료

3. 프로그램 재시작
   - 출결관리 프로그램 종료 후 재실행
   - GPU 메모리 해제됨
```

---

### 5. InsightFace 모델 오류 (Python 소스 사용 시)

**증상:**
- "InsightFace 모델 로드 실패"
- "No module named 'insightface'"

**원인:**
- InsightFace 미설치
- 모델 다운로드 실패
- 인터넷 연결 문제

**해결 방법:**
```
1. InsightFace 재설치
   pip uninstall insightface
   pip install insightface==0.7.3

2. 모델 수동 다운로드
   # 첫 실행 시 자동 다운로드됨
   # 인터넷 연결 확인
   python main.py

3. 모델 캐시 삭제
   # 모델 다운로드 실패 시
   rmdir /s /q %USERPROFILE%\.insightface
   python main.py  # 재다운로드
```

**참고 (EXE 사용 시):**
- EXE에 모델 포함되어 있음
- 별도 다운로드 불필요
- 인터넷 연결 불필요

---

### 6. 프로그램 실행 안 됨

**증상 (EXE):**
- 더블클릭해도 아무 반응 없음
- 실행 후 바로 종료됨

**해결 방법:**
```
1. Windows Defender 확인
   - 바이러스 검사 예외 추가
   - 출결관리.exe 우클릭 → "검사 제외"

2. 프로그램 파일 확인
   - dist/출결관리/ 폴더 전체 복사했는지 확인
   - 출결관리.exe만 복사하면 실행 안 됨
   - _internal/ 폴더도 함께 있어야 함

3. 관리자 권한 실행
   - 출결관리.exe 우클릭
   - "관리자 권한으로 실행"
```

**증상 (Python 소스):**
- "ModuleNotFoundError"
- "ImportError"

**해결 방법:**
```
1. 가상환경 활성화 확인
   conda activate capture
   # 또는
   venv\Scripts\activate

2. 패키지 재설치
   pip install -r requirements.txt

3. Python 버전 확인
   python --version
   # Python 3.10.11이어야 함
```

---

### 7. 설정이 저장 안 됨

**증상:**
- 프로그램 종료 후 재실행 시 설정 초기화
- 모니터, 경로, 학생 수 다시 입력해야 함

**원인:**
- config.json 파일 없음
- config.json 권한 문제

**해결 방법:**
```
1. config.json 위치 확인
   - EXE 실행 시: dist/출결관리/config.json
   - Python 실행 시: 프로젝트 루트/config.json

2. 수동 생성 (없을 시)
   # 프로그램 실행 시 자동 생성됨
   # 한 번 설정 후 종료하면 자동 저장

3. 권한 확인
   - config.json 우클릭 → 속성 → 보안
   - 읽기/쓰기 권한 확인

4. EXE 재빌드 시 (개발자)
   - dist/ 폴더 삭제 시 config.json도 삭제됨
   - 재빌드 후 초기 설정 다시 필요
```

---

## 👨‍💻 개발자 정보

### 프로젝트 구조
```
capture/
├─ main.py                 # 프로그램 진입점
├─ features/               # 핵심 기능
│  ├─ capture.py           # 화면 캡처
│  ├─ face_detection.py    # 얼굴 감지
│  ├─ file_manager.py      # 파일 저장
│  ├─ logger.py            # CSV 로깅
│  └─ scheduler.py         # 스케줄링
├─ gui/                    # GUI
│  ├─ main_window.py       # 메인 윈도우
│  └─ dialogs.py           # 초기 설정 다이얼로그
├─ utils/                  # 유틸리티
│  ├─ config.py            # 설정 관리
│  └─ monitor.py           # 모니터 선택
├─ docs/                   # 문서
│  ├─ requirements.md      # 요구사항 명세서
│  ├─ architecture.md      # 기술 설계서
│  ├─ rules.md             # 개발 규칙
│  └─ tasks.md             # Task 체크리스트
├─ 출결관리.spec            # PyInstaller 설정
├─ build.bat               # EXE 빌드 스크립트
├─ requirements.txt        # Python 패키지
├─ CLAUDE.md               # Claude Code 가이드
└─ README.md               # 이 파일
```

### EXE 빌드 (개발자용)

**빌드 환경:**
```bash
# 가상환경 활성화
conda activate capture

# PyInstaller 설치 (없을 시)
pip install pyinstaller==6.11.0
```

**자동 빌드:**
```bash
build.bat
```

**수동 빌드:**
```bash
# 기존 빌드 삭제
rmdir /s /q build dist

# PyInstaller 실행
pyinstaller 출결관리.spec --clean --noconfirm
```

**빌드 결과:**
```
dist/출결관리/
├─ 출결관리.exe          # 실행 파일 (~500MB)
└─ _internal/            # 의존성 라이브러리
   ├─ .insightface/      # 번들링된 모델
   └─ ...
```

### 기술 스택
- **언어**: Python 3.10.11
- **GUI**: tkinter (Python 내장)
- **얼굴 감지**: InsightFace 0.7.3 (buffalo_l 모델)
- **GPU 가속**: onnxruntime-gpu 1.16.3 (CUDA 11.x)
- **화면 캡처**: mss 9.0.1
- **이미지 처리**: Pillow 10.1.0, numpy 1.24.3
- **배포**: PyInstaller 6.11.0

### 문서
- **요구사항**: [docs/requirements.md](docs/requirements.md)
- **기술 설계**: [docs/architecture.md](docs/architecture.md)
- **개발 규칙**: [docs/rules.md](docs/rules.md)
- **개발 진행**: [docs/tasks.md](docs/tasks.md)

### 라이선스
- InsightFace: MIT License
- 기타 라이브러리: 각 라이브러리의 라이선스 참조

---

**문서 버전**: 1.1
**최종 수정일**: 2025-12-01
**개발 환경**: Windows 10, Python 3.10.11, NVIDIA GTX 960
