# 출결 관리 자동 캡처 프로그램 요구사항 명세서

## 1. 프로젝트 개요

### 1.1 목적
- 온라인 강의(Zoom) 출결 증빙을 위한 자동 화면 캡처 시스템
- 학원과 국가 기관에 제출할 출결 증빙 자료 생성

### 1.2 개발 환경
- **OS**: Windows 10
- **언어**: Python 3.10.11
- **실행 방식**: GUI 기반 데스크톱 애플리케이션
- **모니터 환경**: 듀얼 모니터
- **GPU**: NVIDIA GeForce GTX 960

### 1.3 주요 요구사항
- Zoom 갤러리 뷰 화면 자동 캡처
- 얼굴 감지 기반 자동 캡처 (InsightFace 딥러닝 모델)
- 교시별 자동 스케줄링 (30~45분 사이)
- 퇴실 시간 캡처 (18:30, 30~32분 사이)
- 작업표시줄(시간/날짜) 포함 캡처
- 듀얼 모니터 지원 (캡처 모니터 선택)

---

## 2. 교시 시간표

### 2.1 시간표 구조

| 교시 | 시작 시간 | 종료 시간 | 캡처 시간대 | 캡처 여부 |
|------|----------|----------|------------|----------|
| 1교시 | 09:30 | 10:20 | 09:30~09:45 | ✅ |
| 2교시 | 10:30 | 11:20 | 10:30~10:45 | ✅ |
| 3교시 | 11:30 | 12:20 | 11:30~11:45 | ✅ |
| 4교시 | 12:30 | 13:20 | 12:30~12:45 | ✅ |
| 점심시간 | 13:30 | 14:30 | - | ❌ (제외) |
| 5교시 | 14:30 | 15:20 | 14:30~14:45 | ✅ |
| 6교시 | 15:30 | 16:20 | 15:30~15:45 | ✅ |
| 7교시 | 16:30 | 17:20 | 16:30~16:45 | ✅ |
| 8교시 | 17:30 | 18:20 | 17:30~17:45 | ✅ |
| 퇴실 | 18:30 | - | 18:30~18:32 | ✅ |

### 2.2 캡처 타이밍 상세

#### 2.2.1 교시별 캡처 (1~8교시)
- **캡처 시작**: 각 교시 시작 시간의 30분
- **캡처 종료**: 각 교시 시작 시간의 45분
- **시도 간격**: 10초
- **캡처 기간**: 15분

**예시:**
- 1교시 (09:30 시작) → 09:30~09:45 (시작 0분~15분)
- 2교시 (10:30 시작) → 10:30~10:45 (시작 0분~15분)
- 3교시 (11:30 시작) → 11:30~11:45 (시작 0분~15분)
- 4교시 (12:30 시작) → 12:30~12:45 (시작 0분~15분)
- 5교시 (14:30 시작) → 14:30~14:45 (시작 0분~15분)
- 6교시 (15:30 시작) → 15:30~15:45 (시작 0분~15분)
- 7교시 (16:30 시작) → 16:30~16:45 (시작 0분~15분)
- 8교시 (17:30 시작) → 17:30~17:45 (시작 0분~15분)

#### 2.2.2 퇴실 캡처
- **캡처 시작**: 18:30:00
- **캡처 종료**: 18:32:00
- **시도 간격**: 10초
- **캡처 기간**: 2분
- **파일명**: `YYMMDD_퇴실.png`
- **목적**: 강의 종료 후 학생들의 최종 출석 확인

---

## 3. 기능 요구사항

### 3.1 자동 캡처 시스템

#### 3.1.1 캡처 모드

**A. 정확 모드 (Exact Mode)**
- 설정한 기준 인원과 정확히 일치할 때만 캡처
- 감지 인원 == 기준 인원
- **사용 사례**: 
  - 모든 학생의 캠 환경이 완벽한 경우
  - 엄격한 출결 관리가 필요한 특수 상황

**B. 유연 모드 (Flexible Mode)**
- 설정한 기준 인원의 90% 이상 감지 시 캡처
- 감지 인원 >= 기준 인원 × 0.9
- **왜 이 모드가 필요한가?**

**실제 상황 예시:**

**문제 상황 1: 어두운 방**
```
실제 출석: 학생 21명 + 강사 1명 = 22명 (전원 출석)
학생 환경: 3명이 방을 어둡게 해서 조명 불량
InsightFace 감지: 19명 (어두운 방 3명 감지 실패)

정확 모드 (22명 기준):
- 19명 감지 → 캡처 실패
- 10초 후 재시도 → 계속 19명
- 영원히 캡처 안 됨 ❌

유연 모드 (22명 기준):
- 최소 필요: 22 × 0.9 = 19.8명 (20명)
- 19명 감지 → 19 < 20 → 캡처 실패
- 재시도 후 20명 감지 → 캡처 성공 ✅
```

**문제 상황 2: 캠 각도 문제**
```
실제 출석: 22명 (전원 출석)
학생 환경: 2명이 캠을 45도 이상 틀어서 설치
          1명이 얼굴 일부만 나오게 촬영
InsightFace 감지: 19~20명 (각도 문제로 2~3명 감지 실패)

유연 모드:
- 최소 필요: 20명
- 20명 감지 → 캡처 성공 ✅
```

**문제 상황 3: 화질 낮은 웹캠**
```
실제 출석: 22명 (전원 출석)
학생 환경: 일부 학생의 웹캠 화질이 매우 낮음
InsightFace 감지: 20명 (화질 문제로 2명 감지 실패)

유연 모드:
- 최소 필요: 20명
- 20명 감지 → 캡처 성공 ✅
```

**유연 모드의 장점:**
1. 현실적: 모든 학생의 캠 환경을 통제할 수 없음
2. 효율적: 환경 문제로 무한 재시도 방지
3. 정확함: 여전히 90% 이상 확인 (20/22명)
4. 유연함: 실제 결석자는 여전히 감지됨

#### 3.1.2 동작 흐름

```
1. 프로그램 시작
   ↓
2. 초기 설정
   - 캡처 모니터 선택 (듀얼 모니터)
   - 캡처 모드 선택 (기본: 정확 모드)
   - 출석 학생 수 입력 (기본: 21명)
   - 기준 인원 자동 계산: 21 + 1(강사) = 22명
   ↓
3. 교시별 캡처 시간대 대기
   ↓
4. 캡처 시간대 도달 시 자동 감지 시작
   ↓
5. 화면 캡처 → 얼굴 감지 (InsightFace)
   ↓
6. 감지 인원 확인
   - 정확 모드: 기준 인원 일치? → YES: 7번, NO: 8번
   - 유연 모드: 기준 인원의 90% 이상? → YES: 7번, NO: 8번
   ↓
7. 캡처 성공
   - 파일 저장
   - 상태 업데이트: "✅ 완료 (HH:MM)"
   - 해당 교시 감지 중단
   ↓
8. 캡처 실패
   - 상태 업데이트: "❌ 실패 (N명/M명)"
   - 10초 대기
   - 아직 캡처 시간대 내? → 4번으로 재시도
   - 캡처 시간대 종료? → 감지 중단
```

### 3.2 얼굴 감지

#### 3.2.1 기술 스택
- **라이브러리**: InsightFace (딥러닝 기반)
- **모델**: ArcFace 기반 얼굴 감지 모델
- **GPU**: NVIDIA GeForce GTX 960 (CUDA 가속)
- **감지 대상**: 사람의 얼굴 (각도 무관)
  - 정면, 측면, 45도 이상 모든 각도 감지 가능
  - 어두운 환경에서도 높은 감지율
  - 얼굴의 방향이 아닌 얼굴 자체를 감지
  - **정확도**: 95~99%

#### 3.2.2 감지 프로세스

**올바른 순서 (중요!):**

1. **선택된 모니터 화면 캡처** (메모리에 임시 저장)
2. **캡처된 이미지를 InsightFace로 로드**
3. **GPU를 활용한 얼굴 감지** (GTX 960)
4. **감지된 얼굴 개수 카운트**
5. **기준 인원과 비교**
6. **조건 충족 시**:
   - 1단계에서 캡처한 이미지를 파일로 저장
   - 상태 업데이트: "✅ 완료 (HH:MM)"
   - 해당 교시 감지 중단
7. **조건 불충족 시**:
   - 1단계 이미지 버림
   - 상태 업데이트: "❌ 실패 (N명/M명)"
   - 10초 대기
   - 1단계부터 다시 시도

**핵심 포인트:**
- InsightFace는 화면을 직접 분석할 수 없음 (이미지 필요)
- 먼저 화면을 캡처한 후, 그 이미지를 분석
- 조건 충족 시 **이미 캡처된 이미지**를 저장 (재캡처 아님)
- 캡처 시점과 분석 시점이 동일한 이미지 사용

**InsightFace의 장점:**
- Haar Cascade 대비 3~4배 높은 정확도
- 조명, 각도, 화질에 강함
- 얼굴만 정확히 감지 (뒷모습, 가려진 얼굴 제외)
- GTX 960으로 0.3~0.5초의 빠른 속도

#### 3.2.2.1 얼굴 필터링 기준

**유효한 얼굴 조건:**
- **특징점 가시성**: 눈(최소 한쪽) + 코 + 입꼬리(최소 한쪽) 보임
- **가림 감지**: 손, 컵 등으로 얼굴이 가려지지 않음 (신뢰도 점수 기준)
- **화면 잘림 방지**: Zoom 갤러리 뷰 개별 칸에서 얼굴이 잘리지 않음

**필터링 대상:**
- 얼굴이 부분적으로 가려진 경우 (손, 컵 등)
- 구도상 입이 화면 밖으로 잘린 경우
- 뒷모습이나 극단적인 옆모습
- 신뢰도 점수가 낮은 경우 (기본값: 0.65 미만)

**재시도 메커니즘:**
- 필터링된 경우 10초 후 자동 재시도
- 손으로 가린 사람이 손을 내리면 재시도 시 캡처 성공
- 캡처 시간대(15분) 내에서 지속적으로 재시도

#### 3.2.3 감지 주기
- **10초 간격**으로 반복 시도
- 캡처 시간대 내에서만 시도
- 캡처 성공 시 해당 항목 감지 중단
- 캡처 시간대 종료 시 자동 중단

### 3.3 인원 관리

#### 3.3.1 초기 설정
- 프로그램 시작 시 입력
- **입력 항목**: 출석 학생 수 (강사 제외)
- **기본값**: 21명 (현재 회차 학생 수)
- **자동 계산**: 기준 인원 = 입력값 + 1(강사)

**예시:**
```
입력: 학생 21명
자동 계산: 기준 인원 22명 (학생 21명 + 강사 1명)
```

#### 3.3.2 실시간 수정
- **수정 방식**:
  - 텍스트 입력 필드에 직접 숫자 입력
  - ▲(+1) / ▼(-1) 버튼으로 증감
- **즉시 적용**: 값 변경 시 바로 기준 인원 재계산 및 적용

**사용 사례:**
- 지각생 도착: 학생 수 증가
- 조퇴/외출: 학생 수 감소

### 3.4 교시별 제어

#### 3.4.1 건너뛰기 기능
- 각 교시마다 독립적인 "건너뛰기" 버튼 제공
- 클릭 시 동작:
  - 해당 교시 자동 감지/캡처 중단
  - 상태 변경: "🔍 감지중" → "⏭️ 건너뛰기"

#### 3.4.2 재시도 기능
- 각 교시마다 "재시도" 버튼 제공
- 클릭 시 동작:
  - 해당 교시 상태를 "대기중"으로 초기화
  - 즉시 얼굴 감지 및 캡처 시도 시작
  
**파일 저장 규칙:**
- **캡처 시간대 내 재시도**: 기존 파일 덮어쓰기
  - 예: `251020_1교시.png` → `251020_1교시.png` (덮어쓰기)
  
- **캡처 시간대 종료 후 재시도**: 새 파일명으로 저장
  - 예: `251020_1교시.png` 존재 → `251020_1교시_수정.png` 생성
  - 원본 파일 보존, 수정본 별도 저장

**사용 사례**:
- 캡처된 사진이 마음에 안 들 때
- 일부 학생의 얼굴이 제대로 안 나왔을 때
- 시간 초과 후 수동으로 다시 캡처할 때

### 3.5 모니터 선택 (필수 기능)

#### 3.5.1 듀얼 모니터 환경
- 학원 컴퓨터는 듀얼 모니터 사용 중
- 캡처할 모니터를 명시적으로 선택해야 함

#### 3.5.2 모니터 선택 기능
- **프로그램 시작 시**: 캡처 모니터 선택
- **선택 옵션**:
  - 주 모니터 (Primary Monitor)
  - 보조 모니터 (Secondary Monitor)
  - 모니터 1, 모니터 2 (번호로 표시)
- **변경 가능**: 프로그램 실행 중 언제든 변경 가능

#### 3.5.3 캡처 범위
- 선택된 단일 모니터만 캡처
- 작업표시줄 포함
- 전체 화면 캡처

---

## 4. 파일 저장

### 4.1 저장 경로 구조

```
C:\IBM 비대면/
├─ 251020/
│  ├─ 251020_1교시.png
│  ├─ 251020_2교시.png
│  ├─ 251020_3교시.png
│  ├─ 251020_3교시_수정.png
│  ├─ 251020_4교시.png
│  ├─ 251020_5교시.png
│  ├─ 251020_6교시.png
│  ├─ 251020_7교시.png
│  ├─ 251020_8교시.png
│  ├─ 251020_퇴실.png
│  └─ 251020_log.csv
├─ 251021/
└─ 251022/
```

### 4.2 파일명 규칙
- **폴더명 형식**: `YYMMDD` (예: `251020`)
- **교시 파일명**: `YYMMDD_N교시.png` (예: `251020_1교시.png`)
- **교시 수정 파일명**: `YYMMDD_N교시_수정.png` (예: `251020_1교시_수정.png`)
- **퇴실 파일명**: `YYMMDD_퇴실.png` (예: `251020_퇴실.png`)
- **로그 파일명**: `YYMMDD_log.csv` (예: `251020_log.csv`)

### 4.3 저장 규칙
- **폴더 생성**: 날짜별 폴더 자동 생성 (형식: YYMMDD)
- **파일 형식**: PNG
- **캡처 범위**: 선택된 모니터 전체 화면 (작업표시줄 포함)
- **중복 처리**: 
  - 캡처 시간대 내: 덮어쓰기
  - 캡처 시간대 종료 후: `_수정.png` 추가

---

## 5. GUI 설계

### 5.1 메인 윈도우 구조

```
┌─────────────────────────────────────────────┐
│  출결 관리 자동 캡처 시스템                     │
├─────────────────────────────────────────────┤
│                                             │
│  [상단 정보 영역]                             │
│  📅 날짜: 2025-10-20                        │
│  ⏰ 시간: 09:25:30                          │
│  🖥️  캡처 모니터: [모니터 2 ▼]                │
│                                             │
├─────────────────────────────────────────────┤
│                                             │
│  [인원 관리 영역]                             │
│  👥 출석 관리                                │
│                                             │
│  캡처 모드: [정확 모드 ▼]                       │
│                                             │
│  출석 학생 수: [ 21 ]▲▼ 명                    │
│  기준 인원: 22명 (학생 21명 + 강사 1명)         │
│                                             │
├─────────────────────────────────────────────┤
│                                             │
│  [교시 상태 영역]                             │
│  📊 교시별 캡처 상태                          │
│                                             │
│  1교시 (09:30~10:20) [09:30~09:45]           │
│                     [🕒 대기중]              │
│                     [건너뛰기] [재시도]       │
│                                             │
│  2교시 (10:30~11:20) [10:30~10:45]           │
│                     [🕒 대기중]              │
│                     [건너뛰기] [재시도]       │
│                                             │
│  3교시 (11:30~12:20) [11:30~11:45]           │
│                     [🕒 대기중]             │
│                     [건너뛰기] [재시도]       │
│                                            │
│  4교시 (12:30~13:20) [12:30~12:45]          │
│                     [🕒 대기중]             │
│                     [건너뛰기] [재시도]       │
│                                             │
│  5교시 (14:30~15:20) [14:30~14:45]          │
│                     [🕒 대기중]             │
│                     [건너뛰기] [재시도]       │
│                                             │
│  6교시 (15:30~16:20) [15:30~15:45]          │
│                     [🕒 대기중]             │
│                     [건너뛰기] [재시도]       │
│                                             │
│  7교시 (16:30~17:20) [16:30~16:45]          │
│                     [🕒 대기중]             │
│                     [건너뛰기] [재시도 ]      │
│                                             │
│  8교시 (17:30~18:20) [17:30~17:45]          │
│                     [🕒 대기중]             │
│                     [건너뛰기] [재시 도]      │
│                                             │
│  퇴실 (18:30) [18:30~18:32]                 │
│              [🕒 대기중]                    │
│              [건너뛰기] [재시도]              │
│                                             │
├─────────────────────────────────────────────┤
│                                             │
│  [하단 버튼 영역]                             │
│  [📁 저장 경로 설정]  [📂 저장 폴더 열기]      │
│                                             │
└─────────────────────────────────────────────┘
```

### 5.2 UI 구성요소 상세

#### 5.2.1 상단 정보 영역
- **날짜**: 현재 날짜 (YYYY-MM-DD 형식)
- **시간**: 현재 시간 (HH:MM:SS 형식, 1초마다 업데이트)
- **캡처 모니터**: 드롭다운 메뉴로 모니터 선택 (즉시 적용)

#### 5.2.2 인원 관리 영역
- **캡처 모드 선택**: 드롭다운 메뉴
  - 정확 모드 (기본값)
  - 유연 모드
- **출석 학생 수**: 
  - 텍스트 입력 필드
  - **입력 필드 오른쪽에 ▲▼ 버튼 배치**
  - 기본값: 21명
  - **실시간 적용**
- **기준 인원 표시**: 자동 계산된 값 표시

#### 5.2.3 교시 상태 영역
- **상태 아이콘**:
  - 🕒 대기중
  - 🔍 감지중 (N명)
  - ✅ 완료 (HH:MM)
  - ❌ 실패 (N명/M명)
  - ⏭️ 건너뛰기
  - ⏰ 시간 초과
- **제어 버튼**: 건너뛰기, 재시도

### 5.3 초기 설정 다이얼로그

```
┌─────────────────────────────────┐
│  초기 설정                       │
├─────────────────────────────────┤
│                                 │
│  캡처 모니터 선택                 │
│  ○ 모니터 1 (주 모니터)           │
│  ○ 모니터 2 (보조 모니터)         │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  저장 경로 설정                   │
│  [C:\IBM 비대면]  [찾아보기...]     │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  캡처 모드 선택                   │
│  ● 정확 모드                     │
│     - 기준 인원과 정확히 일치     │
│     - 엄격한 출결 관리           │
│                                 │
│  ○ 유연 모드                      │
│     - 기준 인원의 90% 이상        │
│     - 캠 환경 문제를 고려한 모드   │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  출석 학생 수 (강사 제외)          │
│  [ 21 ]▲▼ 명                    │
│                                 │
│  기준 인원: 22명                 │
│  (학생 21명 + 강사 1명)           │
│                                 │
│  ─────────────────────────────  │
│                                 │
│       [취소]        [시작]       │
│                                 │
└─────────────────────────────────┘
```

---

## 6. 알림 시스템

### 6.1 알림창 (Alert)

#### 6.1.1 캡처 성공 알림 (시간대 내)
```
┌─────────────────────────────┐
│  캡처 성공                   │
├─────────────────────────────┤
│  N교시 캡처가 완료되었습니다.   │
│                             │
│  파일: YYMMDD_N교시.png      │
│  감지 인원: N명               │
│  기준 인원: N명               │
│                             │
│         [확인]               │
└─────────────────────────────┘
```

#### 6.1.2 캡처 성공 알림 (시간대 종료 후)
```
┌─────────────────────────────┐
│  캡처 성공 (시간대 종료 후)    │
├─────────────────────────────┤
│  N교시 캡처가 완료되었습니다.   │
│                             │
│  파일: YYMMDD_N교시_수정.png  │
│  감지 인원: N명               │
│  기준 인원: N명               │
│                             │
│  ※ 원본 파일이 보존되고       │
│     수정본이 별도 저장됨       │
│                             │
│         [확인]               │
└─────────────────────────────┘
```

#### 6.1.3 캡처 실패 알림
```
┌─────────────────────────────┐
│  캡처 실패                   │
├─────────────────────────────┤
│  N교시 얼굴 감지 실패          │
│                             │
│  감지 인원: N명               │
│  기준 인원: N명               │
│  (유연 모드: 최소 N명 필요)    │
│                             │
│  10초 후 재시도합니다.         │
│                             │
│         [확인]               │
└─────────────────────────────┘
```

---

## 7. 기술 명세

### 7.1 개발 환경
- **운영체제**: Windows 10
- **Python 버전**: 3.10.11
- **IDE**: Cursor + Claude Code
- **모니터**: 듀얼 모니터 환경
- **GPU**: NVIDIA GeForce GTX 960

### 7.2 필수 라이브러리

```python
# 화면 캡처
mss

# 이미지 처리
Pillow
numpy

# 얼굴 감지
insightface
onnxruntime-gpu

# GUI
tkinter

# 스케줄링
schedule

# CSV
csv

# CUDA Toolkit 11.x (별도 설치)
```

### 7.3 프로젝트 구조

```
attendance_capture/                    # 프로젝트 루트
│
├─ docs/                               # 📁 문서 폴더
│  ├─ requirements.md                  # 요구사항 명세서
│  ├─ rules.md                         # 개발 규칙
│  ├─ architecture.md                  # 기술 설계서
│  └─ tasks.md                         # Task 체크리스트
│
├─ src/                                # 📁 소스 코드 (또는 attendance_capture/)
│  ├─ __init__.py
│  ├─ main.py                          # 프로그램 진입점
│  │
│  ├─ core/                            # 📁 핵심 로직
│  │  ├─ __init__.py
│  │  ├─ capture.py                    # 화면 캡처
│  │  ├─ face_detection.py             # 얼굴 감지 (InsightFace)
│  │  ├─ scheduler.py                  # 스케줄링
│  │  ├─ file_manager.py               # 파일 저장 관리
│  │  └─ logger.py                     # CSV 로그 기록
│  │
│  ├─ gui/                             # 📁 GUI
│  │  ├─ __init__.py
│  │  ├─ main_window.py                # 메인 윈도우
│  │  └─ dialogs.py                    # 초기 설정 다이얼로그
│  │
│  └─ utils/                           # 📁 유틸리티
│     ├─ __init__.py
│     ├─ config.py                     # 설정 관리 (config.json)
│     └─ monitor.py                    # 모니터 감지 및 선택
│
├─ tests/                              # 📁 테스트 (선택사항)
│  ├─ __init__.py
│  ├─ test_capture.py
│  ├─ test_face_detection.py
│  └─ test_scheduler.py
│
├─ assets/                             # 📁 리소스 (필요 시)
│  └─ icons/                           # 아이콘 (시스템 트레이 등)
│
├─ .gitignore                          # Git 제외 파일
├─ requirements.txt                    # Python 패키지 목록
├─ README.md                           # 프로젝트 소개
└─ .cursorrules                        # Cursor 설정 (선택)

```

### 7.4 InsightFace 모델
- **모델**: buffalo_l
- **크기**: 약 100MB
- **다운로드**: 첫 실행 시 자동
- **위치**: `~/.insightface/models/buffalo_l/`
- **라이선스**: MIT License
- **정확도**: 95~99%
- **속도**: GTX 960 기준 0.3~0.5초

---

## 8. 사용 시나리오

### 8.1 시나리오 1: 정상 출석 (유연 모드)

```
08:00 - 프로그램 시작
      - 모니터 2 선택
      - 저장 경로: C:\IBM 비대면
      - 유연 모드 선택
      - 학생 21명 입력
      - 기준 인원: 22명

09:30 - 1교시 캡처 시작
      - 얼굴 감지: 20명
      - 20 >= 19.8 → 캡처 성공
      - 파일: 251020_1교시.png

18:30 - 퇴실 캡처
      - 얼굴 감지: 20명
      - 파일: 251020_퇴실.png
```

### 8.2 시나리오 2: 지각생 발생

```
09:30 - 1교시 캡처 시작
      - 얼굴 감지: 19명
      - 19 < 19.8 → 실패
      - 10초 후 재시도

09:35 - 담당자 개입
      - 학생 19명으로 수정
      - 기준: 20명

09:35:10 - 재시도
         - 19명 >= 18 → 성공
```

### 8.3 시나리오 3: 재시도 (시간대 내)

```
09:30 - 1교시 캡처 완료
      - 파일: 251020_1교시.png

09:35 - 담당자 확인
      - 사진 품질 불만족
      - 재시도 버튼 클릭

09:35:05 - 재캡처
         - 파일: 251020_1교시.png (덮어쓰기)
```

### 8.4 시나리오 4: 재시도 (시간대 종료 후)

```
09:30 - 1교시 캡처 시간대 시작
      - 감지 실패 반복

09:45 - 시간대 종료
      - 시간 초과 알림

09:50 - 담당자 개입
      - 인원 수정
      - 재시도 버튼 클릭

09:50:05 - 재캡처
         - 파일: 251020_1교시_수정.png (새 파일)
```

---

## 9. 예외 처리

### 9.1 얼굴 감지 실패

**원인**:
1. 실제 결석/지각
2. 환경 문제 (조명, 각도, 화질)
3. Zoom 화면 문제
4. 잘못된 모니터 선택

**처리**:
- 10초마다 재시도
- 실패 알림창
- 시간대 종료 시 중단
- 담당자 개입

### 9.2 파일 저장 실패

**원인**:
- 저장 경로 권한 없음
- 디스크 공간 부족

**처리**:
- 에러 알림창
- 폴더 자동 생성 시도
- 경로 변경 요청

### 9.3 중복 파일 처리

**처리**:
- 시간대 내: 덮어쓰기
- 시간대 종료 후: `_수정.png` 추가

### 9.4 프로그램 강제 종료

**처리**:
- 설정값 저장
- 다음 실행 시 복구

### 9.5 GPU 사용 불가

**처리**:
- CPU 모드로 전환
- 경고 알림

---

## 10. 성능 요구사항

### 10.1 응답 시간
- 얼굴 감지 (GPU): 0.3~0.5초
- 화면 캡처: 0.5초
- 파일 저장: 0.5초

### 10.2 리소스 사용
- CPU: 유휴 시 5% 이하
- GPU: 감지 시 30~50%
- 메모리: 500MB 이하
- VRAM: 1GB 이하

### 10.3 안정성
- 10시간 이상 안정 동작
- 메모리 누수 없음

---

## 11. 추가 기능

### 11.1 설정 저장
- 저장 경로
- 선택 모니터
- 사용 모드
- 학생 수
- 파일: `config.json`

### 11.2 로그 기록

**CSV 구조**:
```csv
날짜,시간,항목,상태,감지인원,기준인원,파일명,비고
2025-10-20,10:00:00,1교시,캡처 시작,0,22,,
2025-10-20,10:00:05,1교시,얼굴 감지,20,22,,
2025-10-20,10:00:07,1교시,캡처 성공,20,22,251020_1교시.png,유연 모드
```

---

## 12. 테스트 케이스

### 12.1 기본 기능

| ID | 테스트 항목 | 예상 결과 |
|----|-----------|----------|
| TC-01 | 프로그램 시작 | 초기 설정 표시 |
| TC-02 | 모니터 선택 | 선택 가능 |
| TC-03 | 유연 모드 선택 | 기본값 설정 |
| TC-04 | 학생 21명 입력 | 기준 22명 |
| TC-05 | ▲ 버튼 | 학생 수 증가 |
| TC-06 | ▼ 버튼 | 학생 수 감소 |
| TC-07 | 10:00 도달 | 자동 감지 시작 |
| TC-08 | 20명 감지 (유연) | 캡처 성공 |
| TC-09 | 18명 감지 (유연) | 캡처 실패 |
| TC-10 | 10:15 도달 | 시간 초과 |
| TC-11 | 건너뛰기 | 감지 중단 |
| TC-12 | 재시도 (시간대 내) | 덮어쓰기 |
| TC-13 | 재시도 (종료 후) | _수정.png |
| TC-14 | 파일 저장 | 정상 저장 |
| TC-15 | CSV 로그 | 정상 기록 |

### 12.2 예외 상황

| ID | 테스트 항목 | 예상 결과 |
|----|-----------|----------|
| TC-16 | 권한 없음 | 에러 알림 |
| TC-17 | 공간 부족 | 에러 알림 |
| TC-18 | Zoom 없음 | 0명 감지 |
| TC-19 | 모니터 연결 해제 | 에러 알림 |
| TC-20 | GPU 불가 | CPU 모드 |

### 12.3 통합 테스트

| ID | 테스트 항목 | 예상 결과 |
|----|-----------|----------|
| TC-21 | 전체 교시 캡처 | 정상 동작 |
| TC-22 | 10시간 실행 | 안정 동작 |
| TC-23 | 메모리 누수 | 누수 없음 |

---

## 13. 배포

### 13.1 시스템 요구사항
- **OS**: Windows 10
- **RAM**: 4GB 이상
- **GPU**: NVIDIA GTX 960 이상 (권장, CPU 모드 fallback 지원)
- **VRAM**: 2GB 이상
- **디스크**: 2GB 이상 (모델 포함 시 약 500MB)
- **CUDA**: 11.x (GPU 사용 시, 선택사항)

### 13.2 EXE 배포 방식

**PyInstaller를 사용한 독립 실행 파일 생성:**
- **빌드 도구**: PyInstaller 6.11.0
- **배포 형태**: --onedir (폴더 + EXE)
- **모델 포함**: InsightFace buffalo_l 모델 (~340MB) 번들링
- **실행 환경**: Python 설치 불필요

**빌드 프로세스:**
```bash
# 가상환경 활성화 후
pyinstaller 출결관리.spec --clean --noconfirm
```

**빌드 결과물:**
```
dist/출결관리/
├─ 출결관리.exe          # 실행 파일
├─ _internal/            # 의존성 라이브러리
│  ├─ .insightface/      # 번들링된 InsightFace 모델
│  ├─ onnxruntime/       # GPU/CPU 런타임
│  └─ ...                # 기타 DLL 및 라이브러리
└─ config.json           # 사용자 설정 파일 (최초 실행 시 생성)
```

**자동 빌드 스크립트:**
- `build.bat`: 기존 빌드 삭제 → PyInstaller 실행 → 결과 안내

### 13.3 사용자 설치 가이드

**방법 1: EXE 실행 (권장)**
1. `dist/출결관리/` 폴더 전체 복사
2. `출결관리.exe` 더블클릭 실행
3. GPU 사용 시 NVIDIA 드라이버만 설치 필요 (CUDA 불필요)
4. CPU 모드 자동 fallback 지원

**방법 2: Python 소스 실행 (개발자용)**
1. Python 3.10.11 설치
2. GPU 드라이버 및 CUDA Toolkit 11.x 설치
3. 가상환경 생성 및 패키지 설치
4. `python main.py` 실행

---

## 14. 개발 우선순위

### Phase 1: 핵심 기능
1. GUI 구조
2. 모니터 선택
3. InsightFace 감지
4. 화면 캡처
5. 파일 저장
6. 스케줄링
7. 알림창

### Phase 2: 제어 기능
8. 인원 관리
9. 건너뛰기
10. 재시도
11. CSV 로그

### Phase 3: 추가 기능
12. 설정 저장
13. 모니터 변경
14. GPU/CPU 전환

### Phase 4: 최적화
15. 성능 최적화
16. 예외 처리
17. 테스트
18. EXE 빌드
19. 문서화
20. 배포

---

## 15. 참고사항

### 15.1 개발 주의사항
- GPU 메모리 누수 방지
- 모니터 인덱스 확인
- 파일명 특수문자 금지
- CSV UTF-8-BOM 인코딩

### 15.2 Zoom 설정
- 갤러리 뷰 고정
- 비디오 꺼진 참가자 숨기기
- Zoom 화면 최대화

### 15.3 운영 권장사항
- 첫 며칠 테스트
- CSV 로그 확인
- GPU 온도 모니터링

---

## 부록 A: 파일명 예시

```
C:\IBM 비대면/251020/
├─ 251020_1교시.png
├─ 251020_2교시.png
├─ 251020_3교시_수정.png
├─ 251020_4교시.png
├─ 251020_5교시.png
├─ 251020_6교시.png
├─ 251020_7교시.png
├─ 251020_8교시.png
├─ 251020_퇴실.png
└─ 251020_log.csv
```

---

## 부록 B: InsightFace vs Haar Cascade

| 항목 | Haar Cascade | InsightFace |
|------|--------------|-------------|
| 정확도 | 60~70% | 95~99% |
| 조명 대응 | 약함 | 강함 |
| 각도 대응 | 제한적 | 모든 각도 |
| 속도 | 0.1초 | 0.5초 |
| GPU | 불필요 | 권장 |
| 크기 | 1MB | 100MB |

---

## 부록 C: 트러블슈팅

### C.1 감지 실패
- 조명 확인
- 카메라 각도 조정
- 기준 인원 확인
- 모니터 확인

### C.2 저장 실패
- 권한 확인
- 공간 확인
- 경로 변경

### C.3 느림
- GPU 확인
- 다른 프로그램 종료
- 재시작

### C.4 InsightFace 오류
- CUDA 설치 확인
- GPU 드라이버 업데이트
- CPU 모드로 전환

---

## 부록 D: 시간표 요약

| 시간 | 이벤트 | 캡처 시간대 |
|------|--------|------------|
| 09:30 | 1교시 | 09:30~09:45 |
| 10:30 | 2교시 | 10:30~10:45 |
| 11:30 | 3교시 | 11:30~11:45 |
| 12:30 | 4교시 | 12:30~12:45 |
| 13:30 | 점심 | - |
| 14:30 | 5교시 | 14:30~14:45 |
| 15:30 | 6교시 | 15:30~15:45 |
| 16:30 | 7교시 | 16:30~16:45 |
| 17:30 | 8교시 | 17:30~17:45 |
| 18:30 | 퇴실 | 18:30~18:32 |

---

**문서 버전**: 4.3
**최종 수정일**: 2025-12-22

**주요 변경사항**:
- 얼굴 필터링 기준 추가 (3.2.2.1)
  - 특징점 가시성 요구사항 (눈/코/입꼬리)
  - 가림 감지 및 화면 잘림 방지
  - 재시도 메커니즘 설명